<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ashte Store Signer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; text-align: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; max-width: 400px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        .input-group { margin-bottom: 15px; text-align: right; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; background: #fafafa; }
        button { width: 100%; padding: 14px; background-color: #007aff; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 15px; font-size: 13px; color: #666; white-space: pre-line; text-align: center; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>

<div class="card">
    <h2>واژۆکردنی IPA</h2>
    
    <div class="input-group">
        <label>1. فایلی IPA هەڵبژێرە:</label>
        <input type="file" id="ipaFile" accept=".ipa">
    </div>

    <div class="input-group">
        <label>2. بڕوانامە (P12):</label>
        <input type="file" id="p12File" accept=".p12">
    </div>

    <div class="input-group">
        <label>3. پڕۆفایلی MobileProvision:</label>
        <input type="file" id="provFile" accept=".mobileprovision">
    </div>

    <div class="input-group">
        <label>4. کۆدی نهێنی (GitHub Token):</label>
        <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
    </div>

    <button id="btn" onclick="startProcess()">ناردن و واژۆکردن</button>
    
    <p id="status"></p>
</div>

<script>
    // ************************************
    // زانیارییەکانت لێرە جێگیر کراون
    const OWNER = 'ashtemzere'; 
    const REPO = 'AshteStore';   
    // ************************************

    async function startProcess() {
        const token = document.getElementById('ghToken').value.trim();
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        
        const ipaFile = document.getElementById('ipaFile').files[0];
        const p12File = document.getElementById('p12File').files[0];
        const provFile = document.getElementById('provFile').files[0];

        if (!token) { alert("تکایە کۆدی تۆکێن (Token) بنووسە"); return; }
        if (!ipaFile || !p12File || !provFile) { alert("تکایە هەموو فایلەکان هەڵبژێرە"); return; }

        btn.disabled = true;
        btn.innerText = "خەریکە دەنێردرێت...";
        status.innerText = "⏳ دەستپێکردنی ناردن...";
        status.className = "";

        try {
            // 1. Upload IPA
            status.innerText = "⏳ خەریکە IPA دەنێردرێت (مەیکەرەوە)...";
            await uploadFile(ipaFile, 'uploads/app.ipa', token);

            // 2. Upload P12
            status.innerText = "⏳ خەریکە P12 دەنێردرێت...";
            await uploadFile(p12File, 'uploads/cert.p12', token);

            // 3. Upload Provision
            status.innerText = "⏳ خەریکە MobileProvision دەنێردرێت...";
            await uploadFile(provFile, 'uploads/profile.mobileprovision', token);

            // Success
            status.innerText = "✅ هەمووی نێردرا!\nGitHub ئێستا خەریکی واژۆکردنە.\nدوای ١-٢ خولەک سەیری بەشی (Actions) بکە.";
            status.className = "success";
            btn.innerText = "سەرکەوتوو بوو";
            
        } catch (error) {
            console.error(error);
            status.innerText = "❌ هەڵە ڕوویدا:\n" + error.message;
            status.className = "error";
            btn.disabled = false;
            btn.innerText = "ناردن و واژۆکردن";
        }
    }

    function uploadFile(file, path, token) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                const base64Content = reader.result.split(',')[1];
                
                // Check if file exists to get SHA (needed for update)
                let sha = null;
                try {
                    const checkUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;
                    const check = await fetch(checkUrl, {
                        headers: { 
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        cache: 'no-store'
                    });
                    if (check.ok) {
                        const data = await check.json();
                        sha = data.sha;
                    }
                } catch(e) { console.log("File is new"); }

                // Upload
                const uploadUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Upload ${path} from web`,
                        content: base64Content,
                        sha: sha
                    })
                });

                if (response.ok) resolve();
                else {
                    const errData = await response.json();
                    reject(new Error(errData.message || "Unknown Upload Error"));
                }
            };
            reader.onerror = () => reject(new Error("File reading failed"));
        });
    }
</script>

</body>
</html>
