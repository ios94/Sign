<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPA Upload & Sign</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f2f2f7; text-align: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 20px; max-width: 400px; margin: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        input, button { width: 100%; margin: 10px 0; padding: 12px; border-radius: 10px; border: 1px solid #ddd; }
        button { background: #007aff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
        #log { font-size: 12px; color: #555; margin-top: 10px; text-align: right; }
    </style>
</head>
<body>

<div class="card">
    <h2>واژۆکردنی ڕاستەوخۆ</h2>
    <p>فایلەکان لە مۆبایلەوە هەڵبژێرە</p>

    <label>فایلی IPA:</label>
    <input type="file" id="ipaFile" accept=".ipa">
    
    <label>فایلی P12:</label>
    <input type="file" id="p12File" accept=".p12">
    
    <label>فایلی MobileProvision:</label>
    <input type="file" id="provFile" accept=".mobileprovision">

    <label>GitHub Token (تۆکێن):</label>
    <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">

    <button id="uploadBtn" onclick="uploadFiles()">ناردن و واژۆکردن</button>
    
    <div id="log"></div>
</div>

<script>
    // زانیاری خۆت لێرە بنووسە
    const OWNER = 'ASHTE_USERNAME'; // ناوی بەکارهێنەری گیت‌هاب
    const REPO = 'ASHTE_REPO';     // ناوی پڕۆژەکە

    async function uploadFiles() {
        const token = document.getElementById('ghToken').value;
        const btn = document.getElementById('uploadBtn');
        const log = document.getElementById('log');

        if (!token) { alert("تکایە تۆکێن بنووسە!"); return; }

        btn.disabled = true;
        btn.innerText = "خەریکە ئەپڵۆد دەبێت...";
        
        const files = [
            { id: 'ipaFile', path: 'uploads/app.ipa' },
            { id: 'p12File', path: 'uploads/cert.p12' },
            { id: 'provFile', path: 'uploads/profile.mobileprovision' }
        ];

        try {
            for (let f of files) {
                const fileInput = document.getElementById(f.id).files[0];
                if (fileInput) {
                    log.innerText += `\n دەستپێکردنی ناردنی ${f.id}...`;
                    await uploadToGithub(fileInput, f.path, token);
                    log.innerText += `\n ✅ ${f.id} نێردرا.`;
                }
            }
            log.innerText += "\n\n هەمووی تەواو بوو! ئێستا GitHub خەریکی واژۆکردنە.";
            btn.innerText = "سەرکەوتوو بوو";
            alert("فایلەکان نێردران. دوای ٢ خولەک سەیری بەشی Releases بکە.");
        } catch (e) {
            log.innerText += `\n ❌ هەڵە: ${e.message}`;
            btn.disabled = false;
        }
    }

    function uploadToGithub(file, path, token) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                const base64Content = reader.result.split(',')[1];
                
                // First, check if file exists to get SHA (needed for update)
                let sha = null;
                try {
                    const check = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
                        headers: { Authorization: `token ${token}` }
                    });
                    if (check.ok) {
                        const data = await check.json();
                        sha = data.sha;
                    }
                } catch(e) {}

                // Upload/Update file
                const response = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Upload ${path}`,
                        content: base64Content,
                        sha: sha
                    })
                });

                if (response.ok) resolve();
                else reject(await response.text());
            };
        });
    }
</script>

</body>
</html>
