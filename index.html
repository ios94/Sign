<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS94 Smart Signer</title>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f2f2f7; text-align: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; max-width: 400px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        .input-group { margin-bottom: 15px; text-align: right; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; background: #fafafa; }
        button { width: 100%; padding: 14px; background-color: #007aff; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #installArea { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .install-btn { background-color: #34c759 !important; font-size: 18px; animation: pop 0.5s ease; }
        
        #status { margin-top: 15px; font-size: 14px; color: #666; white-space: pre-line; direction: ltr; }
        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="card">
    <h2>ÙˆØ§Ú˜Û†Ú©Û•Ø±ÛŒ Ø²ÛŒØ±Û•Ú© - iOS94</h2>
    
    <div id="formArea">
        <div class="input-group"><label>1. ÙØ§ÛŒÙ„ÛŒ IPA:</label><input type="file" id="ipaFile" accept=".ipa"></div>
        <div class="input-group"><label>2. Ø¨Ú•ÙˆØ§Ù†Ø§Ù…Û• (P12):</label><input type="file" id="p12File" accept=".p12"></div>
        <div class="input-group"><label>3. Ú•Û•Ù…Ø²ÛŒ Ø¨Ú•ÙˆØ§Ù†Ø§Ù…Û• (Password):</label><input type="text" id="p12Pass" placeholder="Ú•Û•Ù…Ø² Ø¨Ù†ÙˆÙˆØ³Û•"></div>
        <div class="input-group"><label>4. MobileProvision:</label><input type="file" id="provFile" accept=".mobileprovision"></div>
        <div class="input-group"><label>5. GitHub Token:</label><input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx"></div>

        <button id="btn" onclick="startProcess()">Ù†Ø§Ø±Ø¯Ù† Ùˆ ÙˆØ§Ú˜Û†Ú©Ø±Ø¯Ù†</button>
    </div>

    <p id="status"></p>

    <div id="installArea">
        <h3>âœ… ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆ!</h3>
        <p>Ø¦Û•Ù¾Û•Ú©Û• Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ• Ø¨Û† Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù†</p>
        <a id="installLink" href="#">
            <button class="install-btn">ğŸ“² Install Now (Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù†)</button>
        </a>
        <br><br>
        <a id="downloadLink" href="#" style="font-size:12px; color:blue;">Download IPA File</a>
    </div>
</div>

<script>
    const OWNER = 'ios94';
    const REPO = 'Sign';
    let checkInterval;

    async function startProcess() {
        const token = document.getElementById('ghToken').value.trim();
        const p12Pass = document.getElementById('p12Pass').value.trim();
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        
        const ipaFile = document.getElementById('ipaFile').files[0];
        const p12File = document.getElementById('p12File').files[0];
        const provFile = document.getElementById('provFile').files[0];

        if (!token || !p12Pass || !ipaFile || !p12File || !provFile) { 
            alert("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•"); return; 
        }

        btn.disabled = true;
        status.innerText = "â³ Ø®Û•Ø±ÛŒÚ©Û• ÙØ§ÛŒÙ„Û•Ú©Ø§Ù† Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª...";

        try {
            // Upload Password
            const passBlob = new Blob([p12Pass], { type: 'text/plain' });
            await uploadFile(passBlob, 'uploads/password.txt', token);

            // Upload Files
            await uploadFile(ipaFile, 'uploads/app.ipa', token);
            await uploadFile(p12File, 'uploads/cert.p12', token);
            await uploadFile(provFile, 'uploads/profile.mobileprovision', token);

            status.innerText = "ğŸš€ ÙØ§ÛŒÙ„Û•Ú©Ø§Ù† Ú¯Û•ÛŒØ´ØªÙ†!\nâ³ ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•Û Ø¨Û• (Ù¢ Ø®ÙˆÙ„Û•Ú©)... Ø®Û•Ø±ÛŒÚ©ÛŒ ÙˆØ§Ú˜Û†Ú©Ø±Ø¯Ù†Û•...";
            status.style.color = "blue";
            
            // Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ Ú†Ø§ÙˆØ¯ÛØ±ÛŒ
            monitorStatus(token);

        } catch (error) {
            status.innerText = "âŒ Ù‡Û•ÚµÛ•: " + error.message;
            status.style.color = "red";
            btn.disabled = false;
        }
    }

    async function monitorStatus(token) {
        const status = document.getElementById('status');
        let attempts = 0;
        
        // Ù‡Û•Ù…ÙˆÙˆ Ù¥ Ú†Ø±Ú©Û• Ø¬Ø§Ø±ÛÚ© Ø³Û•ÛŒØ±ÛŒ GitHub Ø¯Û•Ú©Ø§Øª
        checkInterval = setInterval(async () => {
            attempts++;
            status.innerText = `â³ ÙˆØ§Ú˜Û† Ø¯Û•Ú©Ø±ÛØª... (${attempts * 5} Ú†Ø±Ú©Û•)`;
            
            try {
                // Ù‡ÛÙ†Ø§Ù†ÛŒ Ø¯ÙˆØ§ÛŒÛŒÙ† Release
                const response = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/releases/latest`, {
                    headers: { 'Authorization': `token ${token}` }, cache: 'no-store'
                });

                if (response.ok) {
                    const data = await response.json();
                    // Ø¯ÚµÙ†ÛŒØ§Ø¨ÙˆÙˆÙ†Û•ÙˆÛ• Ú©Û• ReleaseÙ€Û•Ú©Û• Ù†ÙˆÛÛŒÛ• (Ú©Û•Ù…ØªØ± Ù„Û• Ù£ Ø®ÙˆÙ„Û•Ú©)
                    const releaseTime = new Date(data.created_at).getTime();
                    const now = new Date().getTime();
                    
                    if ((now - releaseTime) < 180000) { // Ø¦Û•Ú¯Û•Ø± Ú©Û•Ù…ØªØ± Ù„Û• Ù£ Ø®ÙˆÙ„Û•Ú© Ø¨ÙˆÙˆ
                        clearInterval(checkInterval);
                        showInstallButton(data.tag_name);
                    }
                }
            } catch (e) { console.log("Waiting..."); }
            
            if (attempts > 60) { // Ø¯ÙˆØ§ÛŒ Ù¥ Ø®ÙˆÙ„Û•Ú© Ø¯Û•ÙˆÛ•Ø³ØªÛØª
                clearInterval(checkInterval);
                status.innerText = "âŒ Ú©Ø§Øª ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆ. ØªÚ©Ø§ÛŒÛ• Ø¯ÙˆÙˆØ¨Ø§Ø±Û• ØªØ§Ù‚ÛŒ Ø¨Ú©Û•Ø±Û•ÙˆÛ•.";
            }
        }, 5000);
    }

    function showInstallButton(tagName) {
        document.getElementById('status').style.display = 'none';
        document.getElementById('formArea').style.display = 'none';
        document.getElementById('installArea').style.display = 'block';

        const plistUrl = `https://github.com/${OWNER}/${REPO}/releases/download/${tagName}/manifest.plist`;
        const ipaUrl = `https://github.com/${OWNER}/${REPO}/releases/download/${tagName}/signed_app.ipa`;

        document.getElementById('installLink').href = `itms-services://?action=download-manifest&url=${plistUrl}`;
        document.getElementById('downloadLink').href = ipaUrl;
    }

    function uploadFile(file, path, token) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                const base64Content = reader.result.split(',')[1];
                let sha = null;
                try {
                    const check = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
                        headers: { 'Authorization': `token ${token}` }, cache: 'no-store'
                    });
                    if (check.ok) { const data = await check.json(); sha = data.sha; }
                } catch(e) {}

                const response = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Upload ${path}`, content: base64Content, sha: sha })
                });
                if (response.ok) resolve(); else reject(new Error("Upload Failed"));
            };
        });
    }
</script>
</body>
</html>
